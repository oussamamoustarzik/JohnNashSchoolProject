{% include 'Admin/AdminElearning.html'%}
{% load static %}

{% block content %}
<style>
   .grades-table {
    width: 90%;
    border-collapse: collapse;
    font-size: 20px;
    margin-left: 60px;
    margin-top: 15px;
    top: 200px;
    position: absolute;
  }

  .grades-table th,
  .grades-table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
  }

  .grades-table th {
    background-color: #5981ee;
  }

  .grades-table tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  .grades-table td:nth-child(1),
  .grades-table td:nth-child(2) {
    text-align: left;
  }

  .grades-table td:last-child {
    font-weight: bold;
  }

  #search {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    margin-block: 110px;
  }
  header{
    height: 25vh;
    margin-left: 240px;
    border-left: 12px;
    border-radius: 12px;
    width: 60%;
  }
  .title , .title1{
    top: 0;
    width: 50%;
  }
  .title h1{
    font-size: 20px;
    font-weight: 300;
    position: absolute;
    top: 30px;
    left: 90px;
  }
.title1 h1{
  font-size: 20px;
    font-weight: 300;
    position: absolute;
    top: 30px;
    left: 900px;
}
#convertToPdf {
    /* Style the button as desired */
    padding: 10px 20px;
    font-size: 16px;
    background-color: #5981ee;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .button-container {
    /* Position the container at the bottom of the section */
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
  }
</style>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>


</head>

<section class="home-section">
  <section class="attendance">
    <div class="attendance-list">
<header>
      <div class="title" id="title"><h1>Student : <b>{{ eleve }}</b> <br> Classe :<b> {{eleve.id_classe }}</b><br></h1></div>
      <div class="title1" id="title1"><h1>Student_CNE : <b> {{eleve.cne_eleve}} </b> <br> School :<b>John Nash School</b><br></h1></div>


      <div class="form-group">
                <input id="search" class="form-control" type="text" placeholder="Search....." >
      </div></header>

      <table class="grades-table" id="Note_Table">
        <thead>
          <tr>
            <th rowspan="2" colspan="1">Matière</th>
            <th rowspan="2" colspan="1"> SousMatière</th>
            <th colspan="4"> S1</th>
            <th colspan="4">S2</th>
          </tr>  
              <tr>
            <th>DS1</th>
            <th>DS2</th>
            <th>DS3</th>
            <th>Moy</th>
            <th>DS1</th>
            <th>DS2</th>
            <th>DS3</th>
            <th>Moy</th>
          </tr>
        </thead>    
          
            
              
            
          
    

        <tbody id="myTable">
          {% for value in values %}
          {% with value.0 as matiere %} <!--  Français -->
          {% with value.1 as ssmatiere %} <!--  <QuerySet [<SousMatiere: Conjugaison>, <SousMatiere: Grammaire>]> -->
          {% with value.2 as epreuve_list %} <!--  [(<Epreuve: 1>, <SousMatiere: Conjugaison>, 9), (<Epreuve: 2>, <SousMatiere: Conjugaison>, 12), (<Epreuve: 1>, <SousMatiere: Grammaire>, 13), (<Epreuve: 4>, <SousMatiere: Grammaire>, 14), (<Epreuve: 6>, <SousMatiere: Grammaire>, 15)] -->
          {% with value.3 as note_list %} <!--  [(9, Decimal('10.00'), <Epreuve: 1>), (12, Decimal('9.00'), <Epreuve: 2>), (13, Decimal('7.00'), <Epreuve: 1>), (14, Decimal('10.00'), <Epreuve: 4>)] -->
          {% for ssma in ssmatiere %}
          <tr>
            {% if forloop.first %}
            <td rowspan="{{ ssmatiere|length }}">{{ matiere }}</td>
            {% endif %}
            <td>{{ ssma }}</td>

            {% for i in "12374568" %}

            <td>
              {% for epr in epreuve_list %}
              {% if epr.1 == ssma and epr.0|stringformat:"s" == i %}
              {% for n in note_list %}
              {% if n.2 == epr.0 %}
              {{ n.1 }}
              {% endif %}
              {% endfor %}
              {% endif %}
              {% endfor %}

              {% if i == "7" or i == "8" %}
              moy
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
          {% endwith %}
          {% endwith %}
          {% endwith %}
          {% endwith %}
          {% endfor %}
        </tbody>

      </table>
      <div class="button-container"><button id="convertToPdf" >Convert to PDF</button></div>

    </div>
  </section>
</section> 
<!-- Your template HTML code (including the table and other elements) -->

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
 <script>
    function convertToGrayscale(imgData) {
      // Create a canvas and context for the image
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Set the canvas dimensions to the image dimensions
      canvas.width = imgData.width;
      canvas.height = imgData.height;

      // Draw the image on the canvas
      ctx.drawImage(imgData, 0, 0);

      // Get the image data (pixels) from the canvas
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;

      // Convert the image to grayscale
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = avg; // Red component
        data[i + 1] = avg; // Green component
        data[i + 2] = avg; // Blue component
      }

      // Put the modified image data back on the canvas
      ctx.putImageData(imageData, 0, 0);

      // Return the canvas as an image (Data URL)
      return canvas.toDataURL('image/png');
    }
    document.getElementById('convertToPdf').addEventListener('click', function () {
  const studentName = document.getElementById('title').innerText.trim();
  const studentName1 = document.getElementById('title1').innerText.trim();
  const studentImage = "{% static '/image/goo.png' %}";

  getBase64Image(studentImage).then((base64Data) => {
    generatePDF(studentName,studentName1, base64Data);
  });
});
function getBase64Image(imgUrl) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'Anonymous';

    img.onload = function () {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      const dataURL = canvas.toDataURL('image/jpeg');
      resolve(dataURL);
    };

    img.onerror = function () {
      reject(new Error('Failed to load the image.'));
    };

    img.src = imgUrl;
  });
}
function generatePDF(studentName,studentName1,studentImageData) {
  const doc = new jsPDF();
  const pdfWidth = 200; // Change this to your desired width in mm
  const pdfHeight = 150; // Change this to your desired height in mm

  // Add the student's name to the PDF
  doc.setFontSize(14);
  doc.text(`${studentName}`, 15, 30);

  doc.setFontSize(14);
  doc.text(`${studentName1}`, 120, 30);

  // Get the HTML table element by its ID
  const table = document.getElementById('Note_Table');

  // Use html2canvas library to convert the table to an image
  html2canvas(table).then((canvas) => {
    // Convert the image to grayscale
    const grayscaleImgData = convertToGrayscale(canvas);

    // Calculate the aspect ratio to maintain the original table dimensions
    const ratio = canvas.width / canvas.height;
    const pdfHeightCalculated = pdfWidth / ratio;
    const xPosition = (doc.internal.pageSize.width - pdfWidth) / 2;

    // Add the grayscale table image to the PDF
    doc.addImage(grayscaleImgData, 'PNG', xPosition, 70, pdfWidth, pdfHeightCalculated);

    // Save the PDF with the name "student_marks_bulletin.pdf"
    doc.save('student_marks_bulletin.pdf');
  });
}

  // Attach the function to the button click event
  // document.getElementById('convertToPdf').addEventListener('click', generatePDF);
  </script>







{% endblock content %}
